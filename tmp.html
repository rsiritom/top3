<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="Top 3 Movies">Top 3 Movies</title>
    <style>
        /* Your CSS styles */
    </style>
</head>
<body>
    <div class="container">
        <div class="banner">
            <img src="top3movies_banner.png" alt="Top 3 Movies">
        </div>
        <div class="navigation">
            <a href="index.html">
                <img src="back.png" alt="Back" title="Back">
            </a>
            <a href="#" class="share-button">
                <img src="share.png" alt="Share">
            </a>
            <a href="#" class="whatsapp-share-button">
                <img src="sharewhatsapp.png" alt="Share on WhatsApp">
            </a>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <input type="text" id="searchTerm" placeholder="Enter search term">
            <button id="searchButton">Search</button>
        </div>

        <div id="items"></div>
    </div>

    <footer>
        <div class="left">
            <a href="index.html" class="homepage-link" data-translate-key="Homepage">Homepage</a>
        </div>
        <div class="right">
            <strong data-translate-key="Source">Source:</strong>
            <a href="https://www.themoviedb.org/" target="_blank">
                <img src="tmdblogo.png" alt="TMDb Logo">
            </a>
        </div>
    </footer>

    <script>
        const API_KEY = '29a18159e2f43f00312a90a7b88dd8d3';

        async function fetchTopMovies(searchTerm) {
            const itemsContainer = document.getElementById('items');
            itemsContainer.innerHTML = ''; // Clear previous items

            const tmdbUrl = `https://api.themoviedb.org/3/search/movie?api_key=${API_KEY}&with_genres=35&query=${encodeURIComponent(searchTerm)}&language=es-ES`;

            try {
                const response = await fetch(tmdbUrl);
                const data = await response.json();
                const movies = data.results.slice(0, 3); // Get top 3 movies

                movies.forEach(async (movie) => {
                    const movieItem = document.createElement('div');
                    movieItem.classList.add('item');

                    // Fetch trailer and platforms
                    const trailerUrl = await fetchMovieTrailer(movie.id);
                    const platforms = await fetchWatchProviders(movie.id);

                    movieItem.innerHTML = `
                        <img src="https://image.tmdb.org/t/p/w500${movie.poster_path}" alt="${movie.title}">
                        <div class="item-info">
                            <h2>${movie.title}</h2>
                            <p><strong data-translate-key="Release Date">Fecha publicaci칩n:</strong> ${movie.release_date}</p>
                            <p><strong data-translate-key="Rating">Valoraci칩n:</strong> ${movie.vote_average}</p>
                            <p>${movie.overview}</p>
                            <a href="${trailerUrl}" target="_blank" data-translate-key="Watch Trailer">Ver tr치iler</a>
                            <p><strong data-translate-key="Available On">Disponible en:</strong> ${platforms}</p>
                            <a href="https://www.themoviedb.org/movie/${movie.id}" target="_blank" data-translate-key="Learn More">M치s detalles</a>
                        </div>
                    `;

                    itemsContainer.appendChild(movieItem);
                });

            } catch (error) {
                console.error("Failed to fetch top movies:", error);
                itemsContainer.innerHTML = '<p>Error loading movies. Please try again later.</p>';
            }
        }

        async function fetchMovieTrailer(movieId) {
            const trailerUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${API_KEY}&language=es-ES`;
            try {
                const response = await fetch(trailerUrl);
                const data = await response.json();
                const trailer = data.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                return trailer ? `https://www.youtube.com/watch?v=${trailer.key}` : '#'; // Return YouTube trailer link or "#" if not available
            } catch (error) {
                console.error("Failed to fetch trailer:", error);
                return '#'; // Return "#" if any error occurs
            }
        }

        async function fetchWatchProviders(movieId) {
            const providerUrl = `https://api.themoviedb.org/3/movie/${movieId}/watch/providers?api_key=${API_KEY}`;
            try {
                const response = await fetch(providerUrl);
                const data = await response.json();
                const providers = data.results.ES; // Assuming 'ES' for Spain. Change to appropriate region.
                if (providers && providers.flatrate) {
                    return providers.flatrate.map(provider => provider.provider_name).join(', ');
                } else {
                    return 'No disponible en plataformas conocidas'; // If no providers are available
                }
            } catch (error) {
                console.error("Failed to fetch watch providers:", error);
                return 'Error al cargar plataformas'; // Return error message if fetching platforms fails
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initial search for "terror"
            fetchTopMovies('terror');

            // Handle search button click
            document.getElementById('searchButton').addEventListener('click', () => {
                const searchTerm = document.getElementById('searchTerm').value.trim();
                if (searchTerm) {
                    fetchTopMovies(searchTerm);
                }
            });
        });
    </script>
</body>
</html>
